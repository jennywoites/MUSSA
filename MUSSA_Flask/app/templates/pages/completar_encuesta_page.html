{% extends "common/page_base.html" %}

{% block content %}

<script>

    $( function () {
        var paginas = document.getElementById("myTab").children;
        for (var i=1; i<paginas.length; i++) {
            link = paginas[i];
            if ({{paso_activo}} == i-1) {
                $(link).addClass("active");
            } else {
                $(link).removeClass("active");
            }
        }

        agregarAccionesBotonesAnteriorYSiguiente();
        cargarLasRespuestasGuardadas();
    });

    function cargarLasRespuestasGuardadas() {
        var respuestas = {{respuestas | safe}};
        if ($.isEmptyObject(respuestas))
            return;

        var preguntas = {{preguntas | safe}};
        while(preguntas.length > 0) {
            if ($.isEmptyObject(respuestas))
                return;

            var pregunta = preguntas.pop();
            var idPregunta = pregunta["pregunta_encuesta_id"];

            if (idPregunta in respuestas) {
                var respuesta = respuestas[idPregunta];
                delete respuestas[idPregunta];
                var tipo_pregunta = pregunta["tipo"];
                cargarRespuestaGuardada(pregunta, tipo_pregunta, respuesta);
                if (tipo_pregunta == "Si o No") {
                    agregarSubpreguntasSiNo(preguntas, pregunta);
                }
            }
        }
    }

    function agregarSubpreguntasSiNo(preguntas, pregunta_si_no) {
        agregarSubpreguntas(preguntas, pregunta_si_no["rta_si"], 'si');
        agregarSubpreguntas(preguntas, pregunta_si_no["rta_no"], 'no');
    }

    function agregarSubpreguntas(preguntas, subpreguntas, tipo) {
        for (var i=0; i< subpreguntas.length; i++) {
            var subpregunta = subpreguntas[i];
            var datos = {};
            datos["pregunta"] = subpregunta["pregunta"];
            datos["pregunta_id"] = subpregunta["pregunta_id"];
            datos["pregunta_encuesta_id"] = subpregunta["pregunta_id"];
            datos["tipo"] = "Texto Subpregunta";
            datos["tipo_num"] = -1;
            datos["tipo_respuesta_si_no"] = tipo;

            preguntas.push(datos);
        }
    }

    function cargarRespuestaGuardada(pregunta, tipo_pregunta, respuesta) {
        switch(tipo_pregunta) {
            case "Texto Libre":
                return cargarRespuestaTextoLibre(pregunta, respuesta);
            case "Puntaje de 1 a 5":
                return cargarRespuestaPuntaje1a5(pregunta, respuesta);
            case "Numero":
                return cargarRespuestaNumero(pregunta, respuesta);
            case "Horario":
                return cargarRespuestaHorario(pregunta, respuesta);
            case "Docente":
                return cargarRespuestaDocentes(pregunta, respuesta);
            case "Correlativa":
                return cargarRespuestaCorrelativas(pregunta, respuesta);
            case "Estrellas":
                return cargarRespuestaEstrellas(pregunta, respuesta);
            case "Temática de la Materia":
                return cargarRespuestaTematicas(pregunta, respuesta);
            case "Tags / Palabras Clave":
                return cargarRespuestaPalabrasClave(pregunta, respuesta);
            case "Si o No":
                return cargarRespuestaSioNo(pregunta, respuesta);
            case "Texto Subpregunta":
                return cargarRespuestaTextoSubpregunta(pregunta, respuesta);
            default:
                console.log(tipo_pregunta)
                console.log(respuesta)
                return;
        }
    }

    function cargarRespuestaSioNo(pregunta, respuesta) {
        var idPregunta = pregunta['pregunta_encuesta_id'];

        var check_si = document.getElementById('check-si-' + idPregunta);
        var check_no = document.getElementById('check-no-' + idPregunta);

        var esta_marcado_si = (respuesta["respuesta"] == "Si");

        check_si.children[0].children[0].checked = esta_marcado_si;
        check_no.children[0].children[0].checked = !esta_marcado_si;

        mostrarSubpreguntas(esta_marcado_si, idPregunta);
    }

    function cargarRespuestaPalabrasClave(pregunta, respuesta) {
        var idPregunta = pregunta['pregunta_encuesta_id'];
        var palabras_clave = respuesta["palabras_clave"];
        for (var i=0; i<palabras_clave.length; i++) {
            var idx_palabra = (i + 1);
            var palabra_clave = palabras_clave[i].palabra_clave;
            document.getElementById('palabra-' + idx_palabra + '-' + idPregunta).value = palabra_clave;
        }
    }

    function cargarRespuestaTematicas(pregunta, respuesta) {
        var idPregunta = pregunta['pregunta_encuesta_id'];
        var selector = document.getElementById("selector_tematica_" + idPregunta);

        var tematicas = respuesta["tematicas"];
        for (var i=0; i<tematicas.length; i++) {
            var tematica = tematicas[i].tematica;
            var opcionElegida = selector[0];
            document.getElementById("texto_nueva_tematica_" + idPregunta).value = tematica;
            agregarTematicaSeleccionada(idPregunta, opcionElegida);
        }
    }

    function cargarRespuestaEstrellas(pregunta, respuesta) {
        var div_estrellas = document.getElementById("ec-stars-wrapper-" + pregunta['pregunta_encuesta_id']);
        var cantidad_estrellas = respuesta["estrellas"];
        pintarEstrellas(div_estrellas, cantidad_estrellas);
    }

    function cargarRespuestaCorrelativas(pregunta, respuesta) {
        var idPregunta = pregunta["pregunta_encuesta_id"];

        for (var i=0; i<respuesta["materias_correlativas"].length; i++) {
            var idMateria = respuesta["materias_correlativas"][i]["id_materia"];
            var materia = encontrarMateriaSelector(idPregunta, idMateria);
            agregarMateriaCorrelativaALaTabla(materia, idPregunta);
        }
    }

    function encontrarMateriaSelector(idPregunta, idMateria) {
        var selector = document.getElementById("selector_posibles_correlativas_" + idPregunta);
        for(var i=0; i<selector.options.length; i++) {
            var opcionMateria = selector.options[i];
            if (opcionMateria.value == idMateria)
                return opcionMateria;
        }
        return null;
    }

    function cargarRespuestaDocentes(pregunta, respuesta) {
        var idPregunta = pregunta["pregunta_encuesta_id"];
        for (var i=0; i<respuesta["comentarios_docentes"].length; i++) {
            var datos_comentario_docente = respuesta["comentarios_docentes"][i];
            var idDocente = datos_comentario_docente["id_docente"].toString();
            var comentario = datos_comentario_docente["comentario"];
            var docente = encontrarOpcionDocente(idPregunta, idDocente);
            agregarComentarioDocenteALaTabla(idPregunta, docente, comentario);
        }
    }

    function encontrarOpcionDocente(idPregunta, idDocente) {
        var selector_docente = document.getElementById("selector_docentes_" + idPregunta);
        for (var i=0; i<selector_docente.options.length; i++) {
            if (selector_docente.options[i].value == idDocente)
                return selector_docente.options[i];
        }
        return null;
    }

    function cargarRespuestaHorario(pregunta, respuesta) {
        for (var i in respuesta["horarios"]) {
            var horario = respuesta["horarios"][i];
            var idPregunta = pregunta["pregunta_encuesta_id"];
            var dia = horario["dia"];
            var hora_desde = convertirAHoraReloj(horario["hora_desde"]);
            var hora_hasta = convertirAHoraReloj(horario["hora_hasta"]);
            agregarHorarioATabla(dia, hora_desde, hora_hasta, idPregunta);
        }
    }

    function convertirAHoraReloj(horario) {
        var minutos = (horario % 1 == 0) ? "00" : "30";
        var horas = Math.floor(horario).toString();
        horas = (horas.length == 1) ? ("0" + horas) : horas;
        return horas + ":" + minutos;
    }

    function cargarRespuestaPuntaje1a5(pregunta, respuesta) {
        var table = document.getElementById("puntaje1a5-id-" + pregunta['pregunta_encuesta_id']);
        var index = respuesta["puntaje"];
        table.rows[0].cells[index].children[0].checked = true;
    }

    function cargarRespuestaTextoLibre(pregunta, respuesta) {
        var texto_div = document.getElementById('textolibre-id-' + pregunta['pregunta_encuesta_id']);
        texto_div.value = respuesta["texto"];
    }

    function cargarRespuestaTextoSubpregunta(pregunta, respuesta) {
        var tipo = pregunta["tipo_respuesta_si_no"];
        var texto_div = document.getElementById('subpregunta-' + tipo + '-' + pregunta['pregunta_encuesta_id']);
        texto_div.value = respuesta["texto"];
    }

    function cargarRespuestaNumero(pregunta, respuesta) {
        var div_numero = document.getElementById('numero_' + pregunta['pregunta_encuesta_id']);
        div_numero.value = respuesta["numero"];
    }

    function agregarAccionesBotonesAnteriorYSiguiente() {
        var btn_anterior = document.getElementById('boton_anterior');
        var btn_siguiente = document.getElementById('boton_siguiente');

        var paginas_anterior_siguiente = {{ anterior_siguiente[paso_activo] | safe }};

        agregarAccionesBoton(paginas_anterior_siguiente[0], btn_anterior, 'left');
        agregarAccionesBoton(paginas_anterior_siguiente[1], btn_siguiente, 'right');
    }

    function agregarAccionesBoton(url, boton, direccion_flecha) {
        if (url) {
            boton.innerHTML = getBotonFlecha(direccion_flecha, url);
        } else {
            boton.hidden = true;
        }
    }

    function getBotonFlecha(lado, url) {
        var boton = "<button type='button' class='btn btn-default' ";
        boton += "style='background-color: transparent;border-color: transparent;font-size: 30px;color: #9634c1;' ";
        boton += "onclick=validarRespuestasParcialesYGuardarRespuestas('" + url + "');>";
        boton += "<span class='glyphicon glyphicon-arrow-" + lado + "'></span></button>";
        return boton;
    }

    SERVICE_GUARDAR_RESPUESTAS_ENCUESTAS_ALUMNO = '/api/GuardarRespuestasEncuestaAlumno'
    SERVICE_FINALIZAR_ENCUESTAS_ALUMNO = '/api/FinalizarEncuestaAlumno'
    SUCCESS = 200

    function do_request(method, page, parametros, onSucces, onError) {
        var method = method || "GET";

        xmlhttp = new XMLHttpRequest();

        xmlhttp.onreadystatechange = function() {
            if (this.status == 0 || this.readyState != 4)
                return;

            if ( this.status != SUCCESS ) {
                onError(this.status, this.responseText);
            }
            else {
                json_result = (this.responseText == "") ? {} : JSON.parse(this.responseText)
                onSucces(this.status, json_result);
            }
        }

        var encoded_params = jQuery.param(parametros)
        var url = (method == 'GET') ? (page + '?' + encoded_params) : page;

        var async = true;
        xmlhttp.open(method, url, async);

        xmlhttp.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
        xmlhttp.withCredentials = true;

        if (method == 'POST') {
            xmlhttp.setRequestHeader("X-CSRFToken", "{{ csrf_token() }}");
            xmlhttp.send(encoded_params);
        } else {
            xmlhttp.send();
        }
    }

    function validarRespuestasParcialesYGuardarRespuestas(nextUrl) {
        var esGuardadoParcial = true;
        validarRespuestasYGuardarRespuestas(nextUrl, esGuardadoParcial, function(state, result) {
            window.location.replace(nextUrl);
        });
    }

    function validarRespuestasGuardarYFinalizarEncuesta() {
        var nextUrl = '{{ url_for('main.historial_encuestas_page') }}';
        var esGuardadoParcial = false;
        validarRespuestasYGuardarRespuestas(nextUrl, esGuardadoParcial, function(state, result) {
            var param = {};
            param["id_encuesta"] = {{idEncuestaAlumno}};

            var error_al_finalizar = document.getElementById("div_error_finalizar_encuesta");
            error_al_finalizar.hidden = true;

            do_request('POST', SERVICE_FINALIZAR_ENCUESTAS_ALUMNO, param, function(state, result) {
                window.location.replace(nextUrl);
            }, function(state, result) {
                error_al_finalizar.hidden = false;
            })
        });
    }

    function validarRespuestasYGuardarRespuestas(nextUrl, esGuardadoParcial, onSuccess) {
        var preguntas = {{preguntas | safe}};

        var respuestas = [];
        var hay_preguntas_invalidas = validarPreguntasYGenerarDatosDeRespuestas(preguntas, respuestas, esGuardadoParcial);

        var div_error = document.getElementById('div_error_preguntas');
        div_error.hidden = !hay_preguntas_invalidas;

        if (hay_preguntas_invalidas) {
            $('html, body').animate({scrollTop:0}, 'slow');
            return false;
        }

        if ($.isEmptyObject(respuestas)) {
            window.location.replace(nextUrl);
            return true;
        }

        var param = {};
        param["respuestas"] = JSON.stringify(respuestas);
        param["id_encuesta"] = {{idEncuestaAlumno}};
        param["categoria"] = {{paso_activo}};

        var error_al_guardar = document.getElementById("div_error_guardado");
        error_al_guardar.hidden = true;
        do_request('POST', SERVICE_GUARDAR_RESPUESTAS_ENCUESTAS_ALUMNO, param, function(state, result) {
            onSuccess(state, result)
        }, function(state, result) {
            $('html, body').animate({scrollTop:0}, 'slow');
            error_al_guardar.hidden = false;
        })
    }


    function validarPreguntasYGenerarDatosDeRespuestas(preguntas, respuestas, esGuardadoParcial) {
        var hay_preguntas_invalidas = false;
        for (var i=0; i<preguntas.length; i++) {
            var pregunta = preguntas[i];
            if (!preguntaEsValida(pregunta, esGuardadoParcial))
                hay_preguntas_invalidas = true;
            else {
                var respuesta = generarDatosRespuesta(pregunta);
                if (!$.isEmptyObject(respuesta))
                    agregarTodasALaLista(respuesta, respuestas);
            }
        }
        return hay_preguntas_invalidas;
    }

    function generarDatosRespuesta(pregunta) {
        switch(pregunta["tipo"]) {
            case "Texto Libre":
                return generarRespuestaTextoLibre(pregunta);
            case "Puntaje de 1 a 5":
                return generarRespuestaPuntaje(pregunta);
            case "Numero":
                return generarRespuestaNumero(pregunta);
            case "Horario":
                return generarRespuestaHorario(pregunta);
            case "Docente":
                return generarRespuestaDocentes(pregunta);
            case "Correlativa":
                return generarRespuestaCorrelativas(pregunta);
            case "Estrellas":
                return generarRespuestaEstrellas(pregunta);
            case "Temática de la Materia":
                return generarRespuestaTematicas(pregunta);
            case "Tags / Palabras Clave":
                return generarRespuestaPalabrasClave(pregunta);
            case "Si o No":
                return generarRespuestaSioNo(pregunta);
            default:
                return {};
        }
    }

    function generarRespuestaSioNo(pregunta) {
        var idPregunta = pregunta['pregunta_encuesta_id'];
        var check_si = document.getElementById('check-si-' + idPregunta);
        var opcion_si_check = check_si.children[0].children[0].checked;

        var check_no = document.getElementById('check-no-' + idPregunta);
        var opcion_no_check = check_no.children[0].children[0].checked;

        if (!opcion_si_check && !opcion_no_check)
            return {};

        var respuestas = [];
        if (opcion_si_check) {
            var rtas_si = generarRespuestasSubpreguntas(pregunta["rta_si"], 'si');
            agregarTodasALaLista(rtas_si, respuestas);
        }

        if (opcion_no_check) {
            var rtas_no = generarRespuestasSubpreguntas(pregunta["rta_no"], 'no');
            agregarTodasALaLista(rtas_no, respuestas);
        }

        var datos = generarEstructuraRespuestaBase(pregunta)
        datos["respuesta"] = opcion_si_check;
        respuestas.push(datos);

        return respuestas;
    }

    function agregarTodasALaLista(lista_a_agregar, lista_final) {
        // Es un elemento y no una lista
        if (!lista_a_agregar.length && !$.isEmptyObject(lista_a_agregar)) {
            lista_final.push(lista_a_agregar);
            return;
        }

        //Es un elemento vacio o es una lista vacia
        if (!lista_a_agregar.length || lista_a_agregar.length == 0)
            return;

        for (var i=0; i<lista_a_agregar.length; i++) {
            lista_final.push(lista_a_agregar[i]);
        }
    }

    function generarRespuestasSubpreguntas(subpreguntas, tipo) {
        if ($.isEmptyObject(subpreguntas))
            return {};

        var respuestas = [];
        for (var i=0; i<subpreguntas.length; i++) {
            var pregunta = subpreguntas[i];
            var idPregunta = pregunta["pregunta_id"];

            var id_input_texto = 'subpregunta-' + tipo + '-' + idPregunta;
            var texto = document.getElementById(id_input_texto).value;
            if (!textoEsValido(texto))
                continue;

            var datos = generarEstructuraRespuestaBase(pregunta)
            datos["texto"] = texto;
            respuestas.push(datos);
        }

        return respuestas;
    }

    function generarRespuestaPalabrasClave(pregunta) {
        var idPregunta = pregunta['pregunta_encuesta_id'];
        MIN_PALABRAS = 1;
        MAX_PALABRAS = 3;
        var palabras_clave = [];
        for (var i=MIN_PALABRAS; i<=MAX_PALABRAS; i++) {
            var palabra = document.getElementById('palabra-' + i + '-' + idPregunta).value;
            if (textoEsValido(palabra)) {
                palabras_clave.push(palabra);
            }
        }

        if (palabras_clave.length == 0)
            return {};

        var datos = generarEstructuraRespuestaBase(pregunta)
        datos["palabras_clave"] = palabras_clave;
        return datos;
    }

    function generarRespuestaTematicas(pregunta) {
        var tematicas = [];
        var etiquetas_ya_elegidas = $("[id*=texto_id_etiqueta_]");
        for (var i=0; i<etiquetas_ya_elegidas.length; i++) {
            var etiqueta = etiquetas_ya_elegidas[i];
            tematicas.push(etiqueta.value);
        }

        if (tematicas.length == 0)
            return {}

        var datos = generarEstructuraRespuestaBase(pregunta)
        datos["tematicas"] = tematicas;
        return datos;
    }

    function generarEstructuraRespuestaBase(pregunta) {
        var datos = {}
        datos["idPregunta"] = pregunta["pregunta_id"];
        datos["tipo_encuesta"] = pregunta["tipo_num"];
        return datos;
    }

    function generarRespuestaTextoLibre(pregunta) {
        var texto = document.getElementById('textolibre-id-' + pregunta['pregunta_encuesta_id']).value;
        if (texto == "")
            return {};

        var datos = generarEstructuraRespuestaBase(pregunta)
        datos["texto"] = texto;
        return datos;
    }

    function generarRespuestaPuntaje(pregunta) {
        var table = document.getElementById("puntaje1a5-id-" + pregunta['pregunta_encuesta_id']);
        var puntaje = -1;
        for (var i=1; i<6; i++) {
            if (table.rows[0].cells[i].children[0].checked)
                puntaje = i;
        }

        if (puntaje < 0)
            return {}

        var datos = generarEstructuraRespuestaBase(pregunta)
        datos["puntaje"] = puntaje;
        return datos;
    }

    function generarRespuestaEstrellas(pregunta) {
        var div_estrellas = document.getElementById("ec-stars-wrapper-" + pregunta['pregunta_encuesta_id']);
        var estrellas = contarCantidadDeEstrellas(div_estrellas);

        if (estrellas == 0)
            return {};

        var datos = generarEstructuraRespuestaBase(pregunta)
        datos["estrellas"] = estrellas;
        return datos;
    }

    function generarRespuestaNumero(pregunta) {
        var numero = document.getElementById('numero_' + pregunta['pregunta_encuesta_id']).value;
        if (numero == "")
            return {}

        var datos = generarEstructuraRespuestaBase(pregunta)
        datos["numero"] = parseInt(numero);
        return datos;
    }

    function generarRespuestaHorario(pregunta) {
        var horarios = [];
        var tablaHorarios = document.getElementById('tabla_cursos_guardados-' + pregunta['pregunta_encuesta_id']);
        for (var i=1; i<tablaHorarios.rows.length; i++) {
            var datos_horario = tablaHorarios.rows[i].cells;
            horarios.push({
                "dia": datos_horario[0].innerText,
                "hora_desde": datos_horario[1].innerText,
                "hora_hasta": datos_horario[2].innerText
            });
        }

        if (horarios.length == 0)
            return {}

        var datos = generarEstructuraRespuestaBase(pregunta)
        datos["horarios"] = horarios;
        return datos;
    }

    function generarRespuestaDocentes(pregunta) {
        var comentarios_docentes = [];
        var tablaDocentes = document.getElementById('tabla_docentes-' + pregunta['pregunta_encuesta_id']);
        for (var i=1; i<tablaDocentes.rows.length; i++) {
            var datos_docente = tablaDocentes.rows[i].cells;
            var comentario = datos_docente[2].innerText;
            if (textoEsValido(comentario)) {
                comentarios_docentes.push({
                    "id_docente": datos_docente[0].innerText,
                    "comentario": comentario
                });
            }
        }

        if (comentarios_docentes.length == 0)
            return {};

        var datos = generarEstructuraRespuestaBase(pregunta)
        datos["docentes"] = comentarios_docentes;
        return datos;
    }

    function generarRespuestaCorrelativas(pregunta) {
        var correlativas = [];

        var idEncuesta = pregunta['pregunta_encuesta_id'];
        var correlativas_table = document.getElementById("tabla_correlativas_" + idEncuesta);
        for (var i=1; i<correlativas_table.rows.length; i++) {
            var correlativa = correlativas_table.rows[i];
            var idMateria = correlativa.cells[2].innerText;
            correlativas.push(idMateria);
        }

        if (correlativas.length == 0)
            return {};

        var datos = generarEstructuraRespuestaBase(pregunta)
        datos["correlativas"] = correlativas;
        return datos;
    }

    function preguntaEsValida(pregunta, esGuardadoParcial) {
        switch(pregunta["tipo"]) {
            case "Puntaje de 1 a 5":
                return validarPreguntaPuntaje1a5(pregunta, esGuardadoParcial);
            case "Texto Libre":
                return validarPreguntaTexto(pregunta, esGuardadoParcial);
            case "Numero":
                return validarPreguntaNumero(pregunta, esGuardadoParcial);
            case "Horario":
                return validarPreguntaHorario(pregunta, esGuardadoParcial);
            case "Docente":
                return validarPreguntaDocentes(pregunta, esGuardadoParcial);
            case "Correlativa":
                return validarPreguntaCorrelativas(pregunta, esGuardadoParcial);
            case "Estrellas":
                return validarPreguntaEstrellas(pregunta, esGuardadoParcial);
            case "Temática de la Materia":
                return validarPreguntaTematicas(pregunta, esGuardadoParcial);
            case "Tags / Palabras Clave":
                return validarPreguntaPalabrasClave(pregunta, esGuardadoParcial);
            case "Si o No":
                return validarPreguntaSiNo(pregunta, esGuardadoParcial);
            default:
                console.log(pregunta);
                return true;
        }
    }

    function validarPreguntaSiNo(pregunta, esGuardadoParcial) {
        var idPregunta = pregunta['pregunta_encuesta_id'];
        var check_si = document.getElementById('check-si-' + idPregunta);
        var opcion_si_check = check_si.children[0].children[0].checked;

        var check_no = document.getElementById('check-no-' + idPregunta);
        var opcion_no_check = check_no.children[0].children[0].checked;

        if (esGuardadoParcial && !opcion_si_check && !opcion_no_check)
            return true;

        var subpreguntas_si_son_validas = true;
        if (opcion_si_check)
            subpreguntas_si_son_validas = validarSubpreguntas(pregunta["rta_si"], 'si', esGuardadoParcial)

        var subpreguntas_no_son_validas = true;
        if (opcion_no_check)
            subpreguntas_no_son_validas = validarSubpreguntas(pregunta["rta_no"], 'no', esGuardadoParcial)

        var div_error = document.getElementById('div_error_si_o_no-' + idPregunta);
        div_error.hidden = (opcion_si_check || opcion_no_check);

        var es_valida = ((opcion_si_check && subpreguntas_si_son_validas) || (opcion_no_check && subpreguntas_no_son_validas));
        return es_valida;
    }

    function validarSubpreguntas(subpreguntas, tipo, esGuardadoParcial) {
        if ($.isEmptyObject(subpreguntas))
            return true;

        var son_validas = true;
        for (var i=0; i<subpreguntas.length; i++) {
            var pregunta = subpreguntas[i];
            var idPregunta = pregunta["pregunta_id"];

            var id_input_texto = 'subpregunta-' + tipo + '-' + idPregunta;
            var id_div_error = 'div_error_subpregunta-' + tipo + '-' + idPregunta;

            if (!validarPreguntaOSubpreguntaTextoPorIds(id_input_texto, id_div_error, esGuardadoParcial))
                son_validas = false;
        }

        return son_validas;
    }

    function validarPreguntaTematicas(pregunta, esGuardadoParcial) {
        var etiquetas_ya_elegidas = $("[id*=texto_id_etiqueta_]");

        if (etiquetas_ya_elegidas.length == 0)
            return true;

        for (var i=0; i<etiquetas_ya_elegidas.length; i++) {
            var etiqueta = etiquetas_ya_elegidas[i];
            if (!textoEsValido(etiqueta.value))
                return false;
        }

        return true;
    }

    function validarPreguntaPalabrasClave(pregunta, esGuardadoParcial) {
        var idPregunta = pregunta['pregunta_encuesta_id'];
        MIN_PALABRAS = 1;
        MAX_PALABRAS = 3;
        var es_valida = true;
        for (var i=MIN_PALABRAS; i<=MAX_PALABRAS; i++) {
            var palabra = document.getElementById('palabra-' + i + '-' + idPregunta).value;
            if (palabra != "" && !textoEsValido(palabra)) {
                es_valida = false;
                break;
            }
        }

        var div_error = document.getElementById('div_error_palabras_clave-' + idPregunta);
        div_error.hidden = es_valida;
        return es_valida;
    }

    function validarPreguntaCorrelativas(pregunta, esGuardadoParcial) {
        //Tanto en el parcial como en el final, puede no tener ninguna correlativa
        return true;
    }

    function validarPreguntaNumero(pregunta, esParcial) {
        var num_actual = document.getElementById('numero_' + pregunta['pregunta_encuesta_id']).value;

        var es_valida = (num_actual == "") ? esParcial : esNumeroValido(num_actual);

        var div_error = document.getElementById('div_error_numero_' + pregunta['pregunta_encuesta_id']);
        div_error.hidden = es_valida;

        return es_valida;
    }

    function esNumeroValido(num_actual) {
        var MAX_NUM = 7*24; //7 dias * 24 horas
        num_actual = parseInt(num_actual);
        return (0 <= num_actual) && (num_actual <= MAX_NUM);
    }

    function validarPreguntaHorario(pregunta, esParcial) {
        var horarios = 0;
        var tablaHorarios = document.getElementById('tabla_cursos_guardados-' + pregunta['pregunta_encuesta_id']);
        for (var i=1; i<tablaHorarios.rows.length; i++) {
            var datos_horario = tablaHorarios.rows[i].cells;
            if (horarioEsValido(datos_horario))
                horarios += 1;
        }

        // Si es guardado parcial puede no haber horarios cargados
        if (esParcial && horarios == 0 && tablaHorarios.rows.length == 1)
            return true;

        var es_valido = (horarios > 0)
        var div_error = document.getElementById('div_error_horario-id-' + pregunta['pregunta_encuesta_id']);
        div_error.hidden = es_valido;
        return es_valido
    }

    function horarioEsValido(datos_horario) {
        var dia = datos_horario[0].innerText;
        var hora_desde = datos_horario[1].innerText;
        var hora_hasta = datos_horario[2].innerText;
        return (diaEsValido(dia) && horaRelojEsValida(hora_desde) && horaRelojEsValida(hora_hasta));
    }

    function horaRelojEsValida(hora_reloj) {
        var datos = hora_reloj.split(":");
        if (! datos.length == 2)
            return false;

        var horas = parseInt(datos[0]);
        MIN_HORAS = 7;
        MAX_HORAS = 23;
        if (horas < MIN_HORAS || horas > MAX_HORAS)
            return false;

        CERO_MINUTOS = 0;
        MEDIA_HORA = 30;
        var minutos = parseInt(datos[1]);
        return (minutos == CERO_MINUTOS || minutos == MEDIA_HORA);
    }

    function diaEsValido(dia) {
        var DIAS = ["LUNES", "MARTES", "MIERCOLES", "JUEVES", "VIERNES", "SABADO"];
        dia = dia.toUpperCase();
        return (DIAS.indexOf(dia) != -1);
    }

    function validarPreguntaPuntaje1a5(pregunta, esParcial) {
        var table = document.getElementById("puntaje1a5-id-" + pregunta['pregunta_encuesta_id']);
        var cantidad_seleccionadas = 0;
        for (var i=1; i<6; i++) {
            if (table.rows[0].cells[i].children[0].checked)
                cantidad_seleccionadas += 1;
        }

        if (esParcial && cantidad_seleccionadas == 0)
            return true;

        var es_valida = (cantidad_seleccionadas == 1);
        var div_error = document.getElementById("div_error_puntaje1a5-id-" + pregunta['pregunta_encuesta_id']);
        div_error.hidden = es_valida;

        return es_valida;
    }

    function validarPreguntaEstrellas(pregunta, esParcial) {
        var div_estrellas = document.getElementById("ec-stars-wrapper-" + pregunta['pregunta_encuesta_id']);

        var estrellas = contarCantidadDeEstrellas(div_estrellas);

        if (esParcial && estrellas == 0)
            return true;

        var es_valida = (estrellas > 0);
        var div_error = document.getElementById("div_error_estrellas-id-" + pregunta['pregunta_encuesta_id']);
        div_error.hidden = es_valida;

        return es_valida;
    }

    function contarCantidadDeEstrellas(div_estrellas) {
        var estrellas = 0;
        for (var i=0; i<div_estrellas.children.length; i++) {
            var opcion = div_estrellas.children[i];
            if (opcion.style["color"] == "rgb(163, 72, 204)")
                estrellas += 1;
        }
        return estrellas;
    }

    function validarPreguntaTexto(pregunta, esParcial) {
        var id_input_texto = 'textolibre-id-' + pregunta['pregunta_encuesta_id'];
        var id_div_error = 'div_error_textolibre-id-' + pregunta['pregunta_encuesta_id'];
        return validarPreguntaOSubpreguntaTextoPorIds(id_input_texto, id_div_error, esParcial)
    }

    function validarPreguntaOSubpreguntaTextoPorIds(id_input_texto, id_div_error, esParcial) {
        var input_texto = document.getElementById(id_input_texto).value;

        if (esParcial && input_texto == "")
            return true;

        var es_valida = textoEsValido(input_texto);

        var div_error = document.getElementById(id_div_error);
        div_error.hidden = es_valida;

        return es_valida;
    }

    function textoEsValido(input_texto) {
        var texto = getCleanedString(input_texto).replace(/\s/g, "");
        return (texto != "");
    }

    function validarPreguntaDocentes(pregunta, esParcial) {
        var docentes = 0;
        var tablaDocentes = document.getElementById('tabla_docentes-' + pregunta['pregunta_encuesta_id']);
        for (var i=1; i<tablaDocentes.rows.length; i++) {
            var datos_docente = tablaDocentes.rows[i].cells;
            var comentario = datos_docente[2].innerText;
            if (textoEsValido(comentario))
                docentes += 1;
        }

        //Si hay docentes cargados todos deben ser validos, siempre puede no haber ninguno
        var es_valido = (tablaDocentes.rows.length == (docentes + 1));

        var div_error = document.getElementById('div_error_docente-id-' + pregunta['pregunta_encuesta_id']);
        div_error.hidden = es_valido;
        return es_valido;
    }

    function setStarsValue(value, id) {
        var estrellas_element = document.getElementById(id);
        pintarEstrellas(estrellas_element, value);
    }

    function pintarEstrellas(element, cantidad_estrellas) {
        var MAX_ESTRELLAS = 5;

        for(var i=1; i<=cantidad_estrellas; i++)
            element.children[i-1].style["color"] = "#A348CC";

        for (var i=(cantidad_estrellas + 1); i <= MAX_ESTRELLAS; i++)
            element.children[i-1].style["color"] = "#7592A7"
    }

    function mostrarSubpreguntas(es_rta_si, id) {
        div_si = document.getElementById("div-subpregunta-si-pregunta-id-" + id);
        div_no = document.getElementById("div-subpregunta-no-pregunta-id-" + id);

        if (div_si)
            div_si.hidden = !es_rta_si;

        if (div_no)
            div_no.hidden = es_rta_si;
    }

    function actualizarHoraHasta(idPregunta) {
        var hora_desde_element = document.getElementById("hora_desde-" + idPregunta);
        var indice_seleccionado = hora_desde_element.selectedIndex;

        var hora_hasta_element = document.getElementById("hora_hasta-" + idPregunta);
        for (var i=0; i < hora_hasta_element.length; i++) {
            var opcion = hora_hasta_element[i];
            if (i < indice_seleccionado)
                opcion.style["display"] = "none";
            else
                opcion.style["display"] = "";
        }

        hora_hasta_element.selectedIndex = indice_seleccionado;
     }

    function agregarHorario(idPregunta) {
        var dia_element = document.getElementById("horario-dia-" + idPregunta)
        var dia = dia_element[dia_element.selectedIndex].innerHTML;

        var hora_desde_element = document.getElementById("hora_desde-" + idPregunta);
        var hora_desde = hora_desde_element[hora_desde_element.selectedIndex].innerHTML;

        var hora_hasta_element = document.getElementById("hora_hasta-" + idPregunta);
        var hora_hasta = hora_hasta_element[hora_hasta_element.selectedIndex].innerHTML;

        if (!horarioParaAgregarEsValido(dia, hora_desde, hora_hasta, idPregunta))
            return false;

        agregarHorarioATabla(dia, hora_desde, hora_hasta, idPregunta);
    }

    function agregarHorarioATabla(dia, hora_desde, hora_hasta, idPregunta) {
        var horarios_table = document.getElementById("tabla_cursos_guardados-" + idPregunta);
        var horarios = horarios_table.rows;

        var indice = horarios_table.rows.length;
        var row = horarios_table.insertRow(indice);
        var ultimo_id = horarios_table.rows[indice-1].id
        var numero_id = parseInt(ultimo_id.substr(ultimo_id.indexOf("_")+1)) + 1;
        if (isNaN(numero_id))
            numero_id = 0;

        row.id = "horario_" + numero_id;
        row.insertCell(0).innerHTML = dia;
        row.insertCell(1).innerHTML = hora_desde;
        row.insertCell(2).innerHTML = hora_hasta;
        row.insertCell(3).innerHTML = '<button type="button" class="btn btn-default" onclick="eliminarHorario(' + numero_id + ',' + idPregunta +')"><span class="glyphicon glyphicon-trash"></span></button></td>'

        var div_tabla_horarios = document.getElementById("div-tabla-" + idPregunta);
        div_tabla_horarios.hidden = false;
    }

    function eliminarHorario(idHorario, idPregunta) {
        var tabla = document.getElementById("tabla_cursos_guardados-" + idPregunta);

        var horarios = tabla.rows;
        horarios["horario_" + idHorario].remove()

        if (tabla.rows.length == 1) { //Siempre una fila es el encabezado
            var div_tabla_horarios = document.getElementById("div-tabla-" + idPregunta);
            div_tabla_horarios.hidden = true;
        }
    }

    function convertirHorario(horario) {
        hora = parseInt(horario.substring(0,2))
        minutos = parseInt(horario.substring(3))
        if (minutos == 30)
            hora += 0.5
        return hora
    }

    function horarioParaAgregarEsValido(dia, hora_desde, hora_hasta, idPregunta) {
        var error_label = document.getElementById("error_label-" + idPregunta);

        hora_desde = convertirHorario(hora_desde);
        hora_hasta = convertirHorario(hora_hasta);

        var horarios = document.getElementById("tabla_cursos_guardados-" + idPregunta).rows;
        for (var i=0; i<horarios.length; i++) {
            var horario = horarios[i];
            var dia_actual = horario.cells[0].innerText;

            if (dia_actual != dia)
                continue;

            var hora_desde_actual = convertirHorario(horario.cells[1].innerText);
            var hora_hasta_actual = convertirHorario(horario.cells[2].innerText);

            //El curso empieza despues de que termina el nuevo
            if (hora_desde_actual >= hora_hasta)
                continue;

            //El curso comienza antes que el nuevo y termina antes que el
            if (hora_desde_actual < hora_desde && hora_hasta_actual < hora_desde)
                continue;

            error_label.style["display"] = "";
            return false;
        }

        error_label.style["display"] = "none";
        return true;
    }

    function agregar_correlativa(idEncuesta) {
        var selector = document.getElementById("selector_posibles_correlativas_" + idEncuesta);
        var materia = selector[selector.selectedIndex];

        if (materia.hidden)
            return;

        agregarMateriaCorrelativaALaTabla(materia, idEncuesta);
    }

    function agregarMateriaCorrelativaALaTabla(materia, idEncuesta) {
        var correlativas_table = document.getElementById("tabla_correlativas_" + idEncuesta);
        var correlativas = correlativas_table.rows;

        var indice = correlativas.length;
        var row = correlativas_table.insertRow(indice);
        var ultimo_id = correlativas[indice-1].id
        var numero_id = parseInt(ultimo_id.substr(ultimo_id.indexOf("_")+1)) + 1;
        if (isNaN(numero_id))
            numero_id = 0;

        row.id = "materia_" + numero_id + "_" + idEncuesta;
        row.insertCell(0).innerHTML = materia.innerHTML;
        var materiaId = materia.id;
        row.insertCell(1).innerHTML = '<button type="button" class="btn btn-default" onclick="eliminar_correlativa(' + numero_id + ',' + idEncuesta + "," + materiaId + ')"><span class="glyphicon glyphicon-trash"></span></button></td>'

        var celdaId = row.insertCell(2);
        celdaId.innerHTML = materia.value;
        celdaId.hidden = true;

        var div_tabla_correlativas = document.getElementById("div_tabla_correlativas_" + idEncuesta);
        div_tabla_correlativas.hidden = false;

        materia.hidden = true;
        showFirstNotHidden(document.getElementById("selector_posibles_correlativas_" + idEncuesta));
    }

    function showFirstNotHidden(selector) {
        var indexSelected = -1;
        for (var i=0; i<selector.options.length; i++) {
            var opcionMateria = selector.options[i];
            if (!opcionMateria.hidden) {
                indexSelected = i;
                break;
            }
        }
        selector.selectedIndex = indexSelected;
    }

    function eliminar_correlativa(idOpcion, idEncuesta, materia) {
        var tabla = document.getElementById("tabla_correlativas_" + idEncuesta);

        var correlativas = tabla.rows;
        correlativas["materia_" + idOpcion + "_" + idEncuesta].remove()

        if (tabla.rows.length == 1) { //Siempre una fila es el encabezado
            var div_tabla_correlativas = document.getElementById("div_tabla_correlativas_" + idEncuesta);
            div_tabla_correlativas.hidden = true;
        }

        materia.hidden = false;
    }

    function agregarComentarioDocente(idPregunta) {
        var texto_comentario_element = document.getElementById("texto-docentes-" + idPregunta);
        var error_element = document.getElementById("error_label-docentes-" + idPregunta);

        if (eliminarPuntuacionesYEspacios(texto_comentario_element.value) == "") {
            error_element.style["display"] = "";
            return;
        } else {
            error_element.style["display"] = "none";
        }

        var selector_docente = document.getElementById("selector_docentes_" + idPregunta);
        var docente = selector_docente[selector_docente.selectedIndex];

        agregarComentarioDocenteALaTabla(idPregunta, docente, texto_comentario_element.value);

        texto_comentario_element.value = "";
    }

    function agregarComentarioDocenteALaTabla(idPregunta, docente, comentario) {
        var tabla_docentes = document.getElementById("tabla_docentes-" + idPregunta);

        var filas = tabla_docentes.rows;
        var indice = filas.length;
        var row = tabla_docentes.insertRow(indice);
        var ultimo_id = filas[indice-1].id
        var numero_id = parseInt(ultimo_id.substr(ultimo_id.indexOf("_")+1)) + 1;
        if (isNaN(numero_id))
            numero_id = 0;

        row.id = "entradaTablaDocente_" + numero_id + "_" + idPregunta;

        var celdaId = row.insertCell(0);
        celdaId.innerHTML = docente.value;
        celdaId.hidden = true;

        row.insertCell(1).innerHTML = docente.innerText;
        row.insertCell(2).innerHTML = comentario;

        var docenteId = docente.id;

        var botones = '<button type="button" class="btn btn-default" onclick="editarDocente(' + numero_id + ',' + idPregunta + "," + docenteId + ')" style="margin-right: 5px;"><span class="glyphicon glyphicon-pencil"></span></button></td>';
        botones += '<button type="button" class="btn btn-default" onclick="eliminarDocente(' + numero_id + ',' + idPregunta + "," + docenteId + ')" style="margin-right: 5px;"><span class="glyphicon glyphicon-trash"></span></button></td>';
        row.insertCell(3).innerHTML = botones;

        var div_tabla_docentes = document.getElementById("div-tabla-docentes-" + idPregunta);
        div_tabla_docentes.hidden = false;

        docente.hidden = true;
        mostrarOcultarSelectorDocentes(idPregunta);
    }

    function mostrarOcultarSelectorDocentes(idPregunta) {
        var selector_docente = document.getElementById("selector_docentes_" + idPregunta);
        var quedanDocentes = false;
        for (var i=0; i<selector_docente.options.length; i++) {
            if (!selector_docente.options[i].hidden) {
                selector_docente.selectedIndex = i;
                quedanDocentes = true;
                break;
            }
        }

        var div_agregar_docentes = document.getElementById("div_agregar_docentes_" + idPregunta);
        div_agregar_docentes.hidden = !quedanDocentes;
    }

    function editarDocente(numeroId, idPregunta, docenteId) {
        var tabla = document.getElementById("tabla_docentes-" + idPregunta);
        var fila_actual = tabla.rows["entradaTablaDocente_" + numeroId + "_" + idPregunta];
        var comentario = fila_actual.cells[2].innerText;

        eliminarDocente(numeroId, idPregunta, docenteId);

        var texto_comentario_element = document.getElementById("texto-docentes-" + idPregunta);
        texto_comentario_element.value = comentario;

        docenteId.selected = true;
    }

    function eliminarDocente(numeroId, idPregunta, docenteId) {
        var tabla = document.getElementById("tabla_docentes-" + idPregunta);

        var filas = tabla.rows;
        filas["entradaTablaDocente_" + numeroId + "_" + idPregunta].remove()

        if (tabla.rows.length == 1) { //Siempre una fila es el encabezado
            var div_tabla_docentes = document.getElementById("div-tabla-docentes-" + idPregunta);
            div_tabla_docentes.hidden = true;
        }

        docenteId.hidden = false;
        mostrarOcultarSelectorDocentes(idPregunta);
    }

    function eliminarPuntuacionesYEspacios(texto) {
        var nuevo_texto = ""
        for(var i=0; i<texto.length; i++) {
            var caracter = texto[i];
            if (";.- *+-?¿/&$%!,{}[]\n".indexOf(caracter) == -1) {
                nuevo_texto += caracter;
            }
        }
        return nuevo_texto;
    }

    function selector_tematica_change(idPregunta) {
        var selector = document.getElementById("selector_tematica_" + idPregunta);
        var div_texto_nueva_tematica =  document.getElementById("div_texto_nueva_tematica_" + idPregunta);
        if (selector[selector.selectedIndex].id == ("nueva_tematica_" + idPregunta)) {
            div_texto_nueva_tematica.hidden = false;
        } else {
            div_texto_nueva_tematica.hidden = true;
        }
    }

    function agregar_tematica(idPregunta) {
        var selector = document.getElementById("selector_tematica_" + idPregunta);
        var opcionElegida = selector[selector.selectedIndex];

        agregarTematicaSeleccionada(idPregunta, opcionElegida);
    }

    function agregarTematicaSeleccionada(idPregunta, opcionElegida) {
        var selector = document.getElementById("selector_tematica_" + idPregunta);

        // Se vuelve a seleccionar la opcion Nueva Tematica
        selector.selectedIndex = 0;
        selector_tematica_change(idPregunta);

        var idTema = "";
        var texto = "";
        if (opcionElegida.id == ("nueva_tematica_" + idPregunta)) {
            idTema = -1;

            var texto_nueva_tematica = document.getElementById("texto_nueva_tematica_" + idPregunta);
            texto = getCleanedString(texto_nueva_tematica.value);
            texto_nueva_tematica.value = "";

            var error_element = document.getElementById("error_label_tematica_" + idPregunta);
            if (eliminarPuntuacionesYEspacios(texto) == "") {
                error_element.style["display"] = "";
                return;
            } else {
                error_element.style["display"] = "none";
            }

            for(var j=0; j<selector.options.length; j++) {
                var opcion = selector.options[j];
                if (opcion.innerText == texto && !opcion.hidden) {
                    opcion.hidden = true;
                    agregarTematica(opcion.innerText, opcion.value, opcion, idPregunta);
                    return;
                }
            }

            var etiquetas_ya_elegidas = $("[id*=texto_id_etiqueta_]");
            for (var i=0; i<etiquetas_ya_elegidas.length; i++) {
                if (etiquetas_ya_elegidas[i].value == texto)
                    return;
            }

        } else {
            idTema = opcionElegida.value;
            texto = opcionElegida.innerText;
            opcionElegida.hidden = true;
        }

        agregarTematica(texto, idTema, opcionElegida, idPregunta);
    }

    function mostrarOcultarSeleccionMasTematicas(idPregunta) {
        var MAX_TEMATICAS = 10;
        var div_seguir_eligiendo = document.getElementById("div_permitir_agregar_mas_etiquetas_" + idPregunta);
        var etiquetas_ya_elegidas = $("[id*=texto_id_etiqueta_]");
        div_seguir_eligiendo.hidden = (etiquetas_ya_elegidas.length >= MAX_TEMATICAS);
    }

    function agregarTematica(texto, idTema, opcionElegida, idPregunta) {
        var tematicas_elegidas = document.getElementById("tematicas_elegidas_" + idPregunta);

        var nueva_etiqueta = crearEtiquetaTematica(texto, idTema, opcionElegida.id, idPregunta);
        tematicas_elegidas.innerHTML += nueva_etiqueta;

        tematicas_elegidas.hidden = false;
        mostrarOcultarSeleccionMasTematicas(idPregunta);
    }

    function getCleanedString(cadena){
       var specialChars = "!@#$^&%*()+=-[]\/{}|:<>?,.;";

       for (var i = 0; i < specialChars.length; i++) {
           cadena= cadena.replace(new RegExp("\\" + specialChars[i], 'gi'), '');
       }

       cadena = cadena.toUpperCase();

       cadena = cadena.replace(/Á/gi,"A");
       cadena = cadena.replace(/É/gi,"E");
       cadena = cadena.replace(/Í/gi,"I");
       cadena = cadena.replace(/Ó/gi,"O");
       cadena = cadena.replace(/Ú/gi,"U");
       return cadena;
    }

    function crearEtiquetaTematica(texto, idEtiqueta, opcion, idPregunta) {
        etiqueta = "";
        etiqueta += "<div class='col-lg-3' id='div_etiqueta_" + idEtiqueta + "_" + idPregunta + "' style='margin-bottom:5px;'>";
        etiqueta += "<div class='input-group'>";
        etiqueta += "<input type='text' class='form-control' style='background-color: #e8d2f2;' id='texto_id_etiqueta_" + idEtiqueta + "' value='" + texto + "' disabled/>";
        etiqueta += "<span class='input-group-btn'>";
        etiqueta += "<button class='btn btn-mussa-default' type='button'"
        etiqueta += "onclick='eliminarTematica(" + idEtiqueta + "," + opcion + "," + idPregunta + ")'>";
        etiqueta += "<span class='glyphicon glyphicon-trash'></span>";
        etiqueta += "</button>";
        etiqueta += "</span>";
        etiqueta += "</div>";
        etiqueta += "</div>";
        return etiqueta;
    }

    function eliminarTematica(idEtiqueta, opcion, idPregunta) {
        var tematicas_elegidas = document.getElementById("tematicas_elegidas_" + idPregunta);
        var etiqueta_a_eliminar = document.getElementById("div_etiqueta_" + idEtiqueta + "_" + idPregunta);
        tematicas_elegidas.removeChild(etiqueta_a_eliminar);
        if (opcion.id != ("nueva_tematica_" + idPregunta))
            opcion.hidden = false;
        mostrarOcultarSeleccionMasTematicas(idPregunta);
    }

</script>

<!--- Begin Botonera -->
<div class="row">
    <div class="col-md-12 board">
        <div class="board-inner">
            <ul class="nav nav-tabs" id="myTab">
                <div class="liner"></div>
                {% for i in range(titulos | length) %}
                    <li>
                        <a onclick="validarRespuestasParcialesYGuardarRespuestas('{{ url_for(titulos[i]['url'], idEncuestaAlumno=idEncuestaAlumno) }}')"
                           title="{{titulos[i]['titulo']}}">
                            <span class="round-tabs">{{i+1}}<i class="icon icon-profile-male"></i></span>
                        </a>
                    </li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>
<!--- End Botonera -->
<br>

<div class="container">

    <div id="div_error_preguntas" hidden="true">
        <br>
        <div class="alert alert-danger">Una o más preguntas contienen errores. Por favor, modifícalas antes de continuar con el siguiente paso.</div>
    </div>

    <div id="div_error_guardado" hidden="true">
        <br>
        <div class="alert alert-danger">Se produjo un error al guardar los datos de la página actual; es posible que una o más preguntas contengan errores. Por favor, modifícalas antes de continuar con el siguiente paso.</div>
    </div>

    <div>
        <h2>{{encuesta["materia"]["codigo"]}} - {{encuesta["materia"]["nombre"]}} | Curso {{encuesta["curso"]["codigo_curso"]}} | {{encuesta["curso"]["docentes"]}}</h2>

        <h3>Sección {{paso_activo+1}}: {{titulos[paso_activo]["titulo"]}}</h3>
    </div>

    {% for pregunta in preguntas %}

        <br>

        <label><span class="glyphicon glyphicon-chevron-right"></span>  {{pregunta["pregunta"]}}</label>

        <br>

        {% if pregunta["tipo"] == "Puntaje de 1 a 5" %}

            <br>
            <table border="0" id="puntaje1a5-id-{{pregunta['pregunta_encuesta_id']}}" style="background-color: transparent;">
                <tbody>
                    <tr>
                        <td>{{pregunta["texto_min"]}}</td>
                        {% for i in range(1,6) %}
                            <td><input type="radio" name="input_puntaje1a5-id-{{pregunta['pregunta_encuesta_id']}}" value="{{i}}" style="margin:10px;"></td>
                        {% endfor %}
                        <td>{{pregunta["texto_max"]}}</td>
                    </tr>
                </tbody>
            </table>

            <div id="div_error_puntaje1a5-id-{{pregunta['pregunta_encuesta_id']}}" hidden="true">
                <br>
                <div class="alert alert-danger">Selecciona un puntaje</div>
            </div>

        {% elif pregunta["tipo"] == "Texto Libre" %}

            <textarea class="form-control" rows="5" id="textolibre-id-{{pregunta['pregunta_encuesta_id']}}"></textarea>

            <div id="div_error_textolibre-id-{{pregunta['pregunta_encuesta_id']}}" hidden="true">
                <br>
                <div class="alert alert-danger">El texto no puede estar vacío, o lleno solo con espacios y/o símbolos.</div>
            </div>

        {% elif pregunta["tipo"] == "Si o No" %}

            <div class="radio" id="check-si-{{pregunta['pregunta_encuesta_id']}}">
                <label><input type="radio" name="optradio-{{pregunta['pregunta_encuesta_id']}}" onclick="mostrarSubpreguntas(true, '{{pregunta['pregunta_encuesta_id']}}')">Si</label>
            </div>
            <div class="radio" id="check-no-{{pregunta['pregunta_encuesta_id']}}">
                <label><input type="radio" name="optradio-{{pregunta['pregunta_encuesta_id']}}" onclick="mostrarSubpreguntas(false, '{{pregunta['pregunta_encuesta_id']}}')">No</label>
            </div>

            <div id="div_error_si_o_no-{{pregunta['pregunta_encuesta_id']}}" hidden="true">
                <br>
                <div class="alert alert-danger">Debe seleccionar una de las dos opciones.</div>
            </div>

            {% for subpregunta in pregunta["rta_si"] %}
                <div id="div-subpregunta-si-pregunta-id-{{pregunta['pregunta_encuesta_id']}}" hidden="True">
                    <br>

                    <label><span class="glyphicon glyphicon-chevron-right"></span>  {{subpregunta["pregunta"]}}</label>

                    <br>
                    <br>

                    {% if subpregunta["tipo"] == "Texto Libre" %}

                        <textarea class="form-control" rows="5" id="subpregunta-si-{{subpregunta['pregunta_id']}}"></textarea>

                        <div id="div_error_subpregunta-si-{{subpregunta['pregunta_id']}}" hidden="true">
                            <br>
                            <div class="alert alert-danger">El texto no puede estar vacío, o lleno solo con espacios y/o símbolos.</div>
                        </div>

                    {% endif %}

                </div>
            {% endfor %}

            {% for subpregunta in pregunta["rta_no"] %}
                <div id="div-subpregunta-no-pregunta-id-{{pregunta['pregunta_encuesta_id']}}" hidden="True">
                    <br>

                    <label><span class="glyphicon glyphicon-chevron-right"></span>  {{subpregunta["pregunta"]}}</label>

                    <br>
                    <br>

                    {% if subpregunta["tipo"] == "Texto Libre" %}

                        <textarea class="form-control" rows="5" id="subpregunta-no-{{subpregunta['pregunta_id']}}"></textarea>

                        <div id="div_error_subpregunta-no-{{subpregunta['pregunta_id']}}" hidden="true">
                            <br>
                            <div class="alert alert-danger">El texto no puede estar vacío, o lleno solo con espacios y/o símbolos.</div>
                        </div>

                    {% endif %}
                </div>
            {% endfor %}

        {% elif pregunta["tipo"] == "Horario" %}

            <br>
            <div>
                <div class="row">
                    <div class="col-sm-2">
                        <div class="form-group">

                            <select class="form-control" id="horario-dia-{{pregunta['pregunta_encuesta_id']}}" name="dia">
                                {% for dia in dias %}
                                <option>{{dia}}</option>
                                {% endfor %}
                            </select>

                        </div>
                    </div>

                    <div class="col-xs-1">
                        <p>De:</p>
                    </div>

                    <div class="col-sm-2">
                        <div class="form-group">
                            <select class="form-control" id="hora_desde-{{pregunta['pregunta_encuesta_id']}}" name="hora_desde" onchange="actualizarHoraHasta('{{pregunta['pregunta_encuesta_id']}}')">
                                {% for i in range(hora_desde | length) %}
                                <option id="hora_desde_{{i}}">{{hora_desde[i]}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="col-xs-1">
                        <p>A:</p>
                    </div>

                    <div class="col-sm-2">
                        <div class="form-group">
                            <select class="form-control" id="hora_hasta-{{pregunta['pregunta_encuesta_id']}}" name="hora_hasta">
                                {% for i in range(hora_hasta | length) %}
                                <option id="hora_hasta_{{i}}">{{hora_hasta[i]}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <div class="col-sm-2">
                        <div class="form-group">
                            <button type="button" class="btn btn-mussa-default" onclick="agregarHorario('{{pregunta['pregunta_encuesta_id']}}')">Agregar horario</button>
                        </div>
                    </div>

                </div>

                <div class="alert alert-danger" id="error_label-{{pregunta['pregunta_encuesta_id']}}" style="display:none">
                    Este horario es incompatible con los que han sido cargados previamente.
                </div>

            </div>

            <br>

            <div class="form-group" id="div-tabla-{{pregunta['pregunta_encuesta_id']}}" hidden="true">
                <div class='table-responsive'>
                    <table class='table table-hover' id="tabla_cursos_guardados-{{pregunta['pregunta_encuesta_id']}}">
                        <tr>
                            <th>Dia</th>
                            <th>De</th>
                            <th>A</th>
                            <th>Eliminar</th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="div_error_horario-id-{{pregunta['pregunta_encuesta_id']}}" hidden="true">
                <br>
                <div class="alert alert-danger">Debes seleccionar al menos un horario de cursada.</div>
            </div>

        {% elif pregunta["tipo"] == "Docente" %}

            <div id="div_agregar_docentes_{{pregunta['pregunta_encuesta_id']}}">

                <div class="form-group">
                    <select class="form-control" id="selector_docentes_{{pregunta['pregunta_encuesta_id']}}" name="selector_posibles_correlativas_{{pregunta['pregunta_encuesta_id']}}">
                        {% for docente in docentes %}
                            <option id="docente_{{docente['id_docente']}}_{{pregunta['pregunta_encuesta_id']}}" value="{{docente['id_docente']}}">{{docente["nombre_completo"]}}</option>
                        {% endfor %}
                    </select>
                </div>

                <textarea class="form-control" rows="5" id="texto-docentes-{{pregunta['pregunta_encuesta_id']}}"></textarea>

                <br>

                <div class="alert alert-danger" id="error_label-docentes-{{pregunta['pregunta_encuesta_id']}}" style="display:none">
                    El texto del comentario a agregar no puede estar vacío
                </div>

                <button type="button" class="btn btn-mussa-default" onclick="agregarComentarioDocente('{{pregunta['pregunta_encuesta_id']}}')">Agregar Comentario</button>

            </div>

            <br>
            <div class="form-group" id="div-tabla-docentes-{{pregunta['pregunta_encuesta_id']}}" hidden="true">
                <div class='table-responsive'>
                    <table class='table table-hover' id="tabla_docentes-{{pregunta['pregunta_encuesta_id']}}">
                        <tr>
                            <th hidden="true">Id Docente</th>
                            <th>Docente</th>
                            <th>Comentarios</th>
                            <th>Acciones</th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

            <div id="div_error_docente-id-{{pregunta['pregunta_encuesta_id']}}" hidden="true">
                <br>
                <div class="alert alert-danger">El comentario de los docentes ingresados no puede ser vacío. Por favor edita o elimina los docentes con comentarios vacíos o compuestos solo por espacios y/o símbolos.</div>
            </div>


        {% elif pregunta["tipo"] == "Correlativa" %}

            <br>

            <div class="row">
                <div class="col-sm-7">
                    <div class="form-group">
                        <select class="form-control" id="selector_posibles_correlativas_{{pregunta['pregunta_encuesta_id']}}" name="selector_posibles_correlativas_{{pregunta['pregunta_encuesta_id']}}">
                            {% for correlativa in posibles_correlativas %}
                                <option id="materia_opcion_{{correlativa['id_materia']}}_{{pregunta['pregunta_encuesta_id']}}" value="{{correlativa['id_materia']}}">{{correlativa["codigo"]}} - {{correlativa["nombre"]}}</option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="col-sm-2">
                    <button class="btn btn-mussa-default" onclick="agregar_correlativa('{{pregunta['pregunta_encuesta_id']}}')">Agregar</button>
                </div>
            </div>

            <br>

            <div class="form-group" id="div_tabla_correlativas_{{pregunta['pregunta_encuesta_id']}}" hidden="true">
                <div class='table-responsive'>
                    <table class='table table-hover' id="tabla_correlativas_{{pregunta['pregunta_encuesta_id']}}">
                        <tr>
                            <th>Materia</th>
                            <th>Eliminar</th>
                            <th hidden="true">Id Materia</th>
                        </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

        {% elif pregunta["tipo"] == "Estrellas" %}

            <br>
            <div class="ec-stars-wrapper" id="ec-stars-wrapper-{{pregunta['pregunta_encuesta_id']}}">
                {% for i in range(1,6) %}
                    <a href="#" data-value="{{i}}" onclick="setStarsValue({{i}},'ec-stars-wrapper-{{pregunta['pregunta_encuesta_id']}}')">&#9733;</a>
                {% endfor %}
            </div>
            <br>

            <div id="div_error_estrellas-id-{{pregunta['pregunta_encuesta_id']}}" hidden="true">
                <br>
                <div class="alert alert-danger">Debe seleccionar una puntuación de 1 a 5 estrellas.</div>
            </div>

        {% elif pregunta["tipo"] == "Numero" %}

            <br>

            <div class="row">
                <div class="col-sm-2">
                    <input type="number" class="form-control" name="numero_{{pregunta['pregunta_encuesta_id']}}" id="numero_{{pregunta['pregunta_encuesta_id']}}" value="{{pregunta['numero_min']}}" min="{{pregunta['numero_min']}}" max="{{pregunta['numero_max']}}" step="1">
                </div>
            </div>

            <br>

            <div id="div_error_numero_{{pregunta['pregunta_encuesta_id']}}" hidden="true">
                <br>
                <div class="alert alert-danger">La cantidad de horas no puede superar las horas que tiene la semana.</div>
            </div>

        {% elif pregunta["tipo"] == "Tags / Palabras Clave" %}

            <br>

            <div class="row">
                {% for i in range(1,4) %}
                    <div class="col-sm-3">
                        <div class="form-group has-feedback">
                            <input type="text" class="form-control" id="palabra-{{i}}-{{pregunta['pregunta_encuesta_id']}}"/>
                            <i class="glyphicon glyphicon-tag form-control-feedback"></i>
                        </div>
                    </div>
                {% endfor %}
            </div>

            <br>

            <div id="div_error_palabras_clave-{{pregunta['pregunta_encuesta_id']}}" hidden="true">
                <br>
                <div class="alert alert-danger">El texto no puede estar lleno con espacios y/o símbolos.</div>
            </div>

        {% elif pregunta["tipo"] == "Temática de la Materia" %}

            <br>

            <div id="div_permitir_agregar_mas_etiquetas_{{pregunta['pregunta_encuesta_id']}}">
                <div class="row">
                    <div class="col-sm-3">
                        <div class="form-group">
                            <select class="form-control" id="selector_tematica_{{pregunta['pregunta_encuesta_id']}}" name="selector_tematica_{{pregunta['pregunta_encuesta_id']}}" onchange="selector_tematica_change('{{pregunta['pregunta_encuesta_id']}}')">
                                <option id="nueva_tematica_{{pregunta['pregunta_encuesta_id']}}" value="-1">Nueva Temática</option>
                                {% for tematica in tematicas %}
                                    <option id="tematica_opcion_{{tematica['id_tematica']}}_{{pregunta['pregunta_encuesta_id']}}" value="{{tematica['id_tematica']}}">{{tematica["tematica"]}}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="col-sm-3" id="div_texto_nueva_tematica_{{pregunta['pregunta_encuesta_id']}}">
                        <input type="text" class="form-control" id="texto_nueva_tematica_{{pregunta['pregunta_encuesta_id']}}"/>
                    </div>
                    <div class="col-sm-2">
                        <button class="btn btn-mussa-default" onclick="agregar_tematica('{{pregunta['pregunta_encuesta_id']}}')">Agregar</button>
                    </div>
                </div>

                <div class="alert alert-danger" id="error_label_tematica_{{pregunta['pregunta_encuesta_id']}}" style="display:none">
                    El texto de la temática no puede estar vacío
                </div>
            </div>

            <div class="row" id="tematicas_elegidas_{{pregunta['pregunta_encuesta_id']}}" hidden="true"></div>

            <br>

        {% endif %}

    {% endfor %}

    <br>

    <div>
        <div class = "pull-left" id="boton_anterior">
            <button type="button" class="btn btn-default" style="background-color: transparent;border-color: transparent;font-size: 30px;color: #9634c1;"><span class='glyphicon glyphicon-arrow-left'></span></button>
        </div>

        <div class = "pull-right" id="boton_siguiente">
            <button type="button" class="btn btn-default" style="background-color: transparent;border-color: transparent;font-size: 30px;color: #9634c1;"><span class='glyphicon glyphicon-arrow-right'></span></button>
        </div>
    </div>

    <br>
    <br>
    <br>

    <div>
        <label style="font-style: italic; color: #A348CC;">Guardar el estado actual de la encuesta y continuar editándola luego.</label>
        <br>
        <button type="button" class="btn btn-mussa-default" onclick="validarRespuestasParcialesYGuardarRespuestas('{{ url_for('main.historial_encuestas_page') }}')">Guardar y Volver</button>
    </div>

    {% if encuesta_esta_completa %}
        <br>
        <label style="font-style: italic; color: #A348CC;">Al finalizar la encuesta las respuestas son enviadas. Una vez que la encuesta es finalizada ya no es posible volver a editarla.</label>
        <br>
        <button type="button" class="btn btn-mussa-default" onclick="validarRespuestasGuardarYFinalizarEncuesta()">Finalizar Encuesta</button>

        <div id="div_error_finalizar_encuesta" hidden="true">
            <br>
            <div class="alert alert-danger">Se produjo un error al intentar finalizar la encuesta. Por favor inténtalo nuevamente.</div>
        </div>

    {% endif %}

</div>

{% endblock %}